<script>
(function () {
    // --- Variables Globales ---
    var modalOverlay = document.getElementById('video-modal-overlay');
    var modalVideo = document.getElementById('modal-video');
    var modalClose = document.getElementById('modal-close-btn');
    
    // Elementos de detalles
    var detailsContainer = document.getElementById('video-details');
    var detailsTitle = document.getElementById('video-title');
    var detailsMetaLine = document.getElementById('video-meta-line');
    var detailsExtraLine = document.getElementById('video-extra-line');
    var detailsCaption = document.getElementById('video-caption');
    var detailsIds = document.getElementById('video-ids');
    
    // Elementos de mensajes
    var messagesContainer = document.getElementById('video-messages-container');
    var msgToggleBtn = document.getElementById('msg-toggle-btn');
    var msgToggleIcon = document.getElementById('msg-toggle-icon');

    var toggleDuplicates = document.getElementById('toggle-duplicates');
    
    var hiddenVideos = loadHiddenVideos();
    var currentVideoElement = null;
    var currentVideoId = null;
    var hideVideoButton = document.getElementById('btn-hide-video');

    // --- Helpers de Videos Ocultos ---
    function loadHiddenVideos() {
        try {
            var raw = localStorage.getItem('hidden_videos');
            if (!raw) return new Set();
            var arr = JSON.parse(raw);
            if (!Array.isArray(arr)) return new Set();
            return new Set(arr);
        } catch (e) {
            return new Set();
        }
    }

    function saveHiddenVideos() {
        try {
            localStorage.setItem('hidden_videos', JSON.stringify(Array.from(hiddenVideos)));
        } catch (e) {}
    }

    function applyHiddenStateToAll() {
        var items = document.querySelectorAll('.file-item[data-item-type="video"]');
        items.forEach(function (el) {
            var vid = el.dataset.videoId || '';
            if (!vid) return;
            var isHidden = hiddenVideos.has(vid);
            el.dataset.hidden = isHidden ? '1' : '0';
            if (isHidden) {
                el.classList.add('is-hidden-video');
            } else {
                el.classList.remove('is-hidden-video');
            }
        });
    }

    function updateHideVideoButton() {
        if (!hideVideoButton) return;
        if (!currentVideoId) {
            hideVideoButton.style.display = 'none';
            return;
        }
        hideVideoButton.style.display = 'inline-flex';
        var isHidden = hiddenVideos.has(currentVideoId);
        var icon = hideVideoButton.querySelector('i');
        var span = hideVideoButton.querySelector('span');
        if (icon) {
            if (isHidden) {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }
        if (span) {
            span.textContent = isHidden ? 'Quitar oculto' : 'Marcar como oculto';
        }
    }

    // --- Detalles del Video ---
    function fillVideoDetailsFromElement(el) {
        if (!detailsContainer || !el) return;

        var name = el.dataset.name || '';
        var size = el.dataset.size || '';
        var duration = el.dataset.duration || '';
        var width = el.dataset.width || '';
        var height = el.dataset.height || '';
        var mime = el.dataset.mime || '';
        var date = el.dataset.date || '';
        var views = el.dataset.views || '';
        var caption = el.dataset.caption || '';
        var chatId = el.dataset.chatId || '';
        var messageId = el.dataset.messageId || '';
        var fileUniqueId = el.dataset.fileUniqueId || '';
        var messagesCount = el.dataset.messagesCount || '';

        if (detailsTitle) detailsTitle.textContent = name;

        var metaParts = [];
        if (size) metaParts.push(size);
        if (duration) metaParts.push('Duración: ' + duration);
        if (width && height) metaParts.push('Resolución: ' + width + 'x' + height);
        if (mime) metaParts.push(mime);
        if (detailsMetaLine) detailsMetaLine.textContent = metaParts.join(' · ');

        var extraParts = [];
        if (date) extraParts.push('Fecha: ' + date);
        if (views) extraParts.push('Vistas: ' + formatThousands(views));
        if (detailsExtraLine) detailsExtraLine.textContent = extraParts.join(' · ');

        if (detailsCaption) detailsCaption.textContent = caption;

        var idParts = [];
        if (chatId) idParts.push('Chat ID: ' + chatId);
        if (messageId) idParts.push('Mensaje ID: ' + messageId);
        if (fileUniqueId) idParts.push('File Unique ID: ' + fileUniqueId);
        if (messagesCount) idParts.push('Mensajes asociados: ' + formatThousands(messagesCount));
        if (detailsIds) detailsIds.textContent = idParts.join(' · ');
    }

    function clearVideoDetails() {
        if (detailsTitle) detailsTitle.textContent = '';
        if (detailsMetaLine) detailsMetaLine.textContent = '';
        if (detailsExtraLine) detailsExtraLine.textContent = '';
        if (detailsCaption) detailsCaption.textContent = '';
        if (detailsIds) detailsIds.textContent = '';
    }

    // --- Mensajes Relacionados ---
    function clearVideoMessages() {
        if (messagesContainer) {
            messagesContainer.innerHTML = '';
        }
    }

    async function loadVideoMessages(videoId) {
        if (!messagesContainer) return;
        clearVideoMessages();
        if (!videoId) return;
        
        messagesContainer.textContent = 'Cargando mensajes...';
        try {
            const res = await fetch('/api/video/' + encodeURIComponent(videoId) + '/messages');
            if (!res.ok) {
                messagesContainer.textContent = 'Error al cargar mensajes';
                return;
            }
            const data = await res.json();
            const msgs = data.messages || [];
            if (!msgs.length) {
                messagesContainer.textContent = 'No hay otros mensajes registrados para este video.';
                return;
            }
            let html = '';
            msgs.forEach(function (m) {
                const line1Parts = [];
                if (m.date) line1Parts.push(m.date);
                line1Parts.push('chat ' + m.chat_id + ' · msg ' + m.message_id);

                const line2Parts = [];
                if (m.views !== null && m.views !== undefined) line2Parts.push('Vistas: ' + formatThousands(m.views));
                if (m.forwards !== null && m.forwards !== undefined) line2Parts.push('Reenvíos: ' + formatThousands(m.forwards));
                if (m.forward_from_chat_title || m.forward_from_chat_id) {
                    const ffTitle = escapeHtmlStats(m.forward_from_chat_title || '');
                    const ffId = (m.forward_from_chat_id !== null && m.forward_from_chat_id !== undefined)
                        ? (' (' + escapeHtmlStats(m.forward_from_chat_id) + ')')
                        : '';
                    line2Parts.push('Forward de: ' + ffTitle + ffId);
                }

                const caption = m.caption || '';

                html += '<div style="margin-bottom:8px; padding:6px 8px; background:#202020; border-radius:4px;">'
                    + '<div style="font-size:0.75rem; color:#ccc;">' + line1Parts.join(' · ') + '</div>'
                    + '<div style="font-size:0.75rem; color:#aaa;">' + line2Parts.join(' · ') + '</div>'
                    + (caption ? '<div style="margin-top:4px; white-space:pre-wrap;">' + caption.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '')
                    + '</div>';
            });
            messagesContainer.innerHTML = html;
        } catch (e) {
            console.error('Error cargando mensajes de video', e);
            messagesContainer.textContent = 'Error al cargar mensajes';
        }
    }

    // --- Modal Principal ---
    function openVideoModal(url, sourceEl) {
        if (!modalOverlay || !modalVideo || !url) return;
        modalVideo.src = url;
        modalVideo.load();
        if (sourceEl) {
            currentVideoElement = sourceEl;
            fillVideoDetailsFromElement(sourceEl);
            var videoId = sourceEl.dataset.videoId || null;
            currentVideoId = videoId;
            loadVideoMessages(videoId);
            updateHideVideoButton();
        } else {
            currentVideoElement = null;
            currentVideoId = null;
            updateHideVideoButton();
        }
        modalOverlay.classList.add('is-open');
    }

    function closeVideoModal() {
        if (!modalOverlay || !modalVideo) return;
        modalOverlay.classList.remove('is-open');
        modalVideo.pause();
        modalVideo.removeAttribute('src');
        modalVideo.load();
        clearVideoDetails();
        clearVideoMessages();

        if (messagesContainer) messagesContainer.style.display = 'none';
        if (msgToggleIcon) {
            msgToggleIcon.classList.remove('fa-chevron-up');
            msgToggleIcon.classList.add('fa-chevron-down');
        }
    }

    // --- Stats Modal ---
    var statsButton = document.getElementById('btn-stats');
    var statsOverlay = document.getElementById('stats-modal-overlay');
    var statsClose = document.getElementById('stats-modal-close-btn');
    var statsContent = document.getElementById('stats-modal-content');

    function escapeHtmlStats(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatThousands(value) {
        if (value === null || value === undefined) return '';
        var n = Number(value);
        if (!isFinite(n)) return String(value);
        try {
            return new Intl.NumberFormat('es-AR').format(Math.trunc(n));
        } catch (e) {
            return String(Math.trunc(n));
        }
    }

    function closeStatsModal() {
        if (!statsOverlay) return;
        statsOverlay.classList.remove('is-open');
        if (statsContent) statsContent.innerHTML = '';
    }

    async function loadStats() {
        if (!statsContent) return;
        statsContent.textContent = 'Cargando estadísticas...';
        try {
            const res = await fetch('/api/stats?limit=10');
            if (!res.ok) {
                statsContent.textContent = 'Error al cargar estadísticas';
                return;
            }
            const data = await res.json();

            const total = data.total_videos || 0;
            const unique = data.unique_videos || 0;
            const sinThumb = data.videos_sin_thumb || 0;
            const verticales = data.videos_verticales || 0;
            const largos = data.videos_largos_mas_1h || 0;

            const topGroups = Array.isArray(data.top_groups) ? data.top_groups : [];
            const topNoThumb = Array.isArray(data.top_no_thumb_groups) ? data.top_no_thumb_groups : [];
            const restricted = Array.isArray(data.restricted_forward_groups) ? data.restricted_forward_groups : [];

            var html = '';

            html += '<div class="stats-grid">'
                + '<div class="stats-card"><div class="stats-label">Videos (total)</div><div class="stats-value">' + escapeHtmlStats(formatThousands(total)) + '</div></div>'
                + '<div class="stats-card"><div class="stats-label">Videos únicos</div><div class="stats-value">' + escapeHtmlStats(formatThousands(unique)) + '</div></div>'
                + '<div class="stats-card"><div class="stats-label">Sin thumb</div><div class="stats-value">' + escapeHtmlStats(formatThousands(sinThumb)) + '</div></div>'
                + '<div class="stats-card"><div class="stats-label">Verticales</div><div class="stats-value">' + escapeHtmlStats(formatThousands(verticales)) + '</div></div>'
                + '<div class="stats-card"><div class="stats-label">Largos (&gt; 1h)</div><div class="stats-value">' + escapeHtmlStats(formatThousands(largos)) + '</div></div>'
                + '</div>';

            html += '<div class="stats-section"><div class="stats-section-title">Grupos con más videos (excluyendo DUMP)</div>';
            if (!topGroups.length) {
                html += '<div class="stats-empty">Sin datos</div>';
            } else {
                html += '<div class="stats-list">';
                topGroups.forEach(function (g, idx) {
                    var pos = idx + 1;
                    var name = g.name || g.chat_id;
                    var tgLink = g.telegram_link || '';

                    var left = '<div class="stats-list-left">' + escapeHtmlStats(pos) + '. ';
                    if (tgLink) {
                        left += '<a href="' + escapeHtmlStats(tgLink) + '" target="_blank" rel="noopener noreferrer">'
                            + escapeHtmlStats(name)
                            + '</a>';
                    } else {
                        left += escapeHtmlStats(name);
                    }
                    left += '</div>';

                    html += '<div class="stats-list-item">'
                        + left
                        + '<div class="stats-list-right">' + escapeHtmlStats(formatThousands(g.videos || 0)) + '</div>'
                        + '</div>';
                });
                html += '</div>';
            }
            html += '</div>';

            html += '<div class="stats-section"><div class="stats-section-title">Canales/Grupos con más videos sin thumb (excluyendo DUMP)</div>';
            if (!topNoThumb.length) {
                html += '<div class="stats-empty">Sin datos</div>';
            } else {
                html += '<div class="stats-list">';
                topNoThumb.forEach(function (g, idx) {
                    var pos = idx + 1;
                    var name = g.name || g.chat_id;
                    var tgLink = g.telegram_link || '';

                    var left = '<div class="stats-list-left">' + escapeHtmlStats(pos) + '. ';
                    if (tgLink) {
                        left += '<a href="' + escapeHtmlStats(tgLink) + '" target="_blank" rel="noopener noreferrer">'
                            + escapeHtmlStats(name)
                            + '</a>';
                    } else {
                        left += escapeHtmlStats(name);
                    }
                    left += '</div>';

                    var sinThumb = escapeHtmlStats(formatThousands(g.sin_thumb || 0));
                    var dumpPct = g.dump_percentage !== undefined && g.dump_percentage !== null
                        ? (' (' + escapeHtmlStats(g.dump_percentage) + '% DUMP)')
                        : '';

                    html += '<div class="stats-list-item">'
                        + left
                        + '<div class="stats-list-right">' + sinThumb + dumpPct + '</div>'
                        + '</div>';
                });
                html += '</div>';
            }
            html += '</div>';

            html += '<div class="stats-section"><div class="stats-section-title">Grupos que no permiten compartir</div>';
            if (!restricted.length) {
                html += '<div class="stats-empty">Sin datos</div>';
            } else {
                html += '<div class="stats-list">';
                restricted.forEach(function (g, idx) {
                    var pos = idx + 1;
                    var name = g.name || g.chat_id;
                    var tgLink = g.telegram_link || '';

                    var left = '<div class="stats-list-left">' + escapeHtmlStats(pos) + '. ';
                    if (tgLink) {
                        left += '<a href="' + escapeHtmlStats(tgLink) + '" target="_blank" rel="noopener noreferrer">'
                            + escapeHtmlStats(name)
                            + '</a>';
                    } else {
                        left += escapeHtmlStats(name);
                    }
                    left += '</div>';

                    html += '<div class="stats-list-item">'
                        + left
                        + '<div class="stats-list-right">' + escapeHtmlStats(formatThousands(g.blocked || 0)) + '</div>'
                        + '</div>';
                });
                html += '</div>';
            }
            html += '</div>';

            statsContent.innerHTML = html;
        } catch (e) {
            console.error('Error cargando stats', e);
            statsContent.textContent = 'Error al cargar estadísticas';
        }
    }

    function openStatsModal() {
        if (!statsOverlay) return;
        statsOverlay.classList.add('is-open');
        loadStats();
    }

    // --- Duplicados ---
    function applyDuplicateFilter() {
        if (!toggleDuplicates) return;
        var hideMode = toggleDuplicates.checked;
        var seen = new Set();
        var items = document.querySelectorAll('.file-item[data-item-type="video"]');
        items.forEach(function (el) {
            var vid = el.dataset.videoId || '';
            var isHidden = el.dataset.hidden === '1';
            
            if (!hideMode) {
                el.style.display = '';
                return;
            }
            // Si está oculto manualmente
            if (isHidden) {
                el.style.display = 'none';
                if (vid) seen.add(vid);
                return;
            }
            // Si es duplicado de uno ya visto
            if (!vid) {
                el.style.display = '';
                return;
            }
            if (seen.has(vid)) {
                el.style.display = 'none';
            } else {
                seen.add(vid);
                el.style.display = '';
            }
        });
    }

    // --- Hover Previews ---
    function setupHoverPreviews() {
        var cards = document.querySelectorAll('.file-item[data-item-type="video"]');
        cards.forEach(function (card) {
            // Prevenir duplicidad de listeners si se llama varias veces
            if (card.dataset.hoverInitialized === '1') return;
            card.dataset.hoverInitialized = '1';

            card.addEventListener('mouseenter', function () {
                if (card.dataset.previewActive === '1' || card.dataset.previewLoading === '1') return;
                var streamUrl = card.dataset.streamUrl;
                if (!streamUrl) return;

                var box = card.querySelector('.icon-box.video-box');
                if (!box) return;

                var spinner = box.querySelector('.video-loading-spinner');
                if (spinner) spinner.style.display = 'flex';

                card.dataset.previewLoading = '1';

                var timerId = setTimeout(function () {
                    if (!card.matches(':hover')) {
                        card.dataset.previewLoading = '0';
                        if (spinner) spinner.style.display = 'none';
                        return;
                    }

                    if (box.querySelector('video.video-preview')) return;

                    var preview = document.createElement('video');
                    preview.className = 'video-preview';
                    preview.src = streamUrl;
                    preview.muted = true;
                    preview.autoplay = true;
                    preview.loop = true;
                    preview.playsInline = true;
                    preview.playbackRate = 2.0;

                    preview.addEventListener('loadeddata', function () {
                        if (!card.matches(':hover')) return;
                        preview.classList.add('is-visible');
                        if (spinner) spinner.style.display = 'none';
                        card.dataset.previewLoading = '0';
                    });

                    preview.addEventListener('error', function () {
                        if (spinner) spinner.style.display = 'none';
                        card.dataset.previewLoading = '0';
                    });

                    box.appendChild(preview);
                    card.dataset.previewActive = '1';
                }, 500);

                card.dataset.previewTimer = String(timerId);
            });

            card.addEventListener('mouseleave', function () {
                var timerId = card.dataset.previewTimer;
                if (timerId) {
                    clearTimeout(Number(timerId));
                    delete card.dataset.previewTimer;
                }

                var box = card.querySelector('.icon-box.video-box');
                if (box) {
                    var preview = box.querySelector('video.video-preview');
                    if (preview) {
                        try { preview.pause(); } catch (e) {}
                        preview.remove();
                    }
                    var spinner = box.querySelector('.video-loading-spinner');
                    if (spinner) spinner.style.display = 'none';
                }

                card.dataset.previewActive = '0';
                card.dataset.previewLoading = '0';
            });
        });
    }

    // --- Search Handler (GLOBAL) ---
    var searchForm = document.getElementById('search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', async function (ev) {
            ev.preventDefault();
            const q = (document.getElementById('search-query')?.value || '').trim();
            const scope = document.getElementById('search-scope')?.value || 'local';
            const type = document.getElementById('search-type')?.value || 'video';
            console.log('[search] submit', { q, scope, type });
            if (!q) return;

            const grid = document.querySelector('.grid-view');
            const title = document.querySelector('.section-title');
            if (!grid) console.warn('[search] No se encontró grid-view para renderizar resultados');
            if (title) title.textContent = 'Buscando...';
            if (grid) grid.innerHTML = '<div style="padding:12px;">Cargando...</div>';

            try {
                const params = new URLSearchParams({ q, scope, type });
                const res = await fetch('/api/search?' + params.toString());
                if (!res.ok) throw new Error('Error búsqueda');
                const data = await res.json();
                const items = data.items || [];
                console.log('[search] resultados', items.length);

                if (title) title.textContent = `Resultados (${formatThousands(items.length)})`;
                if (!grid) return;

                let html = '';
                if (type === 'video') {
                    items.forEach((item) => {
                        const link = `/play/${encodeURIComponent(item.chat_id || '')}/${encodeURIComponent(item.message_id || '')}`;
                        const durationText = item.duration ? `${Math.floor(item.duration / 60)}:${(item.duration % 60).toString().padStart(2, '0')}` : '';
                        const name = (item.text || item.file_name || 'Video').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const sizeTxt = item.file_size ? `${(item.file_size / (1024 * 1024)).toFixed(1)} MB` : '';
                        html += '<a href="' + link + '" class="file-item" data-item-type="video"'
                            + ' data-stream-url="' + link.replace('/play/', '/video_stream/') + '"'
                            + (item.id ? ' data-video-id="' + String(item.id) + '"' : '')
                            + (item.chat_id ? ' data-chat-id="' + String(item.chat_id) + '"' : '')
                            + (item.message_id ? ' data-message-id="' + String(item.message_id) + '"' : '')
                            + (item.mime_type ? ' data-mime="' + String(item.mime_type) + '"' : '')
                            + (item.date ? ' data-date="' + String(item.date) + '"' : '')
                            + (item.text ? ' data-caption="' + String(item.text).replace(/"/g, '&quot;') + '"' : '')
                            + '>';
                        html += '<div class="icon-box video-box">'
                            + '<div class="video-hidden-indicator" title="Marcado como oculto"><i class="fas fa-eye-slash"></i></div>'
                            + '<div class="video-loading-spinner" aria-hidden="true"><i class="fas fa-circle-notch fa-spin"></i></div>'
                            + '<i class="fas fa-file-video file-video"></i>';
                        if (durationText) html += '<div class="video-duration">' + durationText + '</div>';
                        html += '</div>'
                            + '<div class="file-name" title="' + name + '">' + name + '</div>'
                            + '<div class="file-info">' + (sizeTxt || '') + '</div>'
                            + '</a>';
                    });
                } else if (type === 'chat') {
                    items.forEach((item) => {
                        const link = `/channel/${encodeURIComponent(item.chat_id || '')}`;
                        const name = (item.name || item.chat_id || 'Chat').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        html += '<a href="' + link + '" class="file-item" data-item-type="chat">'
                            + '<div class="icon-box folder-box"><i class="fas fa-folder folder-chat folder-icon"></i></div>'
                            + '<div class="file-name" title="' + name + '">' + name + '</div>'
                            + '<div class="file-info">' + (item.username ? '@' + item.username : '') + '</div>'
                            + '</a>';
                    });
                } else {
                    items.forEach((item) => {
                        const text = (item.text || item.file_name || '').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const info = `chat ${item.chat_id || ''} · msg ${item.message_id || ''}`;
                        html += '<div class="file-item" style="cursor:default;">'
                            + '<div class="file-name" title="' + text + '">' + text + '</div>'
                            + '<div class="file-info">' + info + '</div>'
                            + '</div>';
                    });
                }

                grid.innerHTML = html || '<div style="padding:12px;">Sin resultados</div>';
                applyHiddenStateToAll();
                applyDuplicateFilter();
                setupHoverPreviews(); // Re-aplicar listeners para nuevos items
            } catch (e) {
                if (title) title.textContent = 'Error en la búsqueda';
                if (grid) grid.innerHTML = '<div style="padding:12px;">Error al buscar</div>';
                console.error(e);
            }
        });
    }

    // --- Event Listeners Globales ---
    if (modalOverlay) {
        modalOverlay.addEventListener('click', function (ev) {
            if (ev.target === modalOverlay) closeVideoModal();
        });
    }
    if (modalClose) modalClose.addEventListener('click', closeVideoModal);

    if (statsButton) statsButton.addEventListener('click', openStatsModal);
    if (statsOverlay) {
        statsOverlay.addEventListener('click', function (ev) {
            if (ev.target === statsOverlay) closeStatsModal();
        });
    }
    if (statsClose) statsClose.addEventListener('click', closeStatsModal);

    if (hideVideoButton) {
        hideVideoButton.addEventListener('click', function () {
            if (!currentVideoId || !currentVideoElement) return;
            var isHidden = hiddenVideos.has(currentVideoId);
            if (isHidden) {
                hiddenVideos.delete(currentVideoId);
                currentVideoElement.dataset.hidden = '0';
                currentVideoElement.classList.remove('is-hidden-video');
            } else {
                hiddenVideos.add(currentVideoId);
                currentVideoElement.dataset.hidden = '1';
                currentVideoElement.classList.add('is-hidden-video');
            }
            saveHiddenVideos();
            updateHideVideoButton();
            applyDuplicateFilter();
        });
    }

    if (msgToggleBtn && messagesContainer && msgToggleIcon) {
        msgToggleBtn.addEventListener('click', function() {
            var isHidden = (messagesContainer.style.display === 'none');
            if (isHidden) {
                messagesContainer.style.display = 'block';
                msgToggleIcon.classList.remove('fa-chevron-down');
                msgToggleIcon.classList.add('fa-chevron-up');
            } else {
                messagesContainer.style.display = 'none';
                msgToggleIcon.classList.remove('fa-chevron-up');
                msgToggleIcon.classList.add('fa-chevron-down');
            }
        });
    }

    if (toggleDuplicates) {
        toggleDuplicates.addEventListener('change', applyDuplicateFilter);
    }

    // Delegación click para videos
    document.addEventListener('click', function (event) {
        var target = event.target.closest('.file-item[data-item-type="video"]');
        if (!target) return;
        var streamUrl = target.dataset.streamUrl;
        if (!streamUrl) return;
        event.preventDefault();
        openVideoModal(streamUrl, target);
    });

    // Delegación click para telegram
    document.addEventListener('click', function (event) {
        var tgBtn = event.target.closest('.btn-open-telegram');
        if (!tgBtn) return;
        var tgLink = tgBtn.getAttribute('data-telegram-link') || '';
        if (!tgLink) return;
        event.preventDefault();
        event.stopPropagation();
        window.open(tgLink, '_blank', 'noopener,noreferrer');
    });

    // Tecla Escape
    document.addEventListener('keydown', function (event) {
        if (event.key !== 'Escape') return;
        if (statsOverlay && statsOverlay.classList.contains('is-open')) {
            closeStatsModal();
            return;
        }
        if (modalOverlay && modalOverlay.classList.contains('is-open')) {
            closeVideoModal();
        }
    });

    // --- Sincronización de Carpeta (WebSocket) ---
    function setupLiveFolderUpdates() {
        var container = document.querySelector('.container[data-folder-id]');
        if (!container) return;

        var folderId = container.getAttribute('data-folder-id');
        if (!folderId) return;

        var grid = container.querySelector('.grid-view');
        if (!grid) return;

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderItems(items) {
            if (!Array.isArray(items)) return;
            var html = '';

            items.forEach(function (item) {
                var name = escapeHtml(item.name || '');
                var count = escapeHtml(item.count || '');
                var link = item.link || '#';
                var type = item.type || 'chat';
                var photoId = item.photo_id;
                var telegramLink = item.telegram_link || '';

                if (type === 'video') {
                    var videoId = item.video_id || '';
                    var chatId = item.chat_id || '';
                    var durationText = item.duration_text || '';
                    var streamUrl = item.stream_url || (item.link || '').replace('/play/', '/video_stream/');

                    html += '<a href="' + link + '" class="file-item" data-item-type="video"'
                        + ' data-stream-url="' + escapeHtml(streamUrl) + '"'
                        + (videoId ? ' data-video-id="' + escapeHtml(videoId) + '"' : '')
                        + (chatId ? ' data-chat-id="' + escapeHtml(chatId) + '"' : '')
                        + '>';

                    html += '<div class="icon-box video-box">'
                        + '<div class="video-hidden-indicator" title="Marcado como oculto">'
                        + '<i class="fas fa-eye-slash"></i>'
                        + '</div>'
                        + '<div class="video-loading-spinner" aria-hidden="true">'
                        + '<i class="fas fa-circle-notch fa-spin"></i>'
                        + '</div>';

                    if (photoId) {
                        html += '<img src="/api/photo/' + encodeURIComponent(photoId) + '?chat_id='
                            + encodeURIComponent(chatId) + '&video_id=' + encodeURIComponent(videoId)
                            + '" class="video-thumb" loading="lazy">';
                    } else {
                        html += '<i class="fas fa-file-video file-video"></i>';
                    }

                    if (durationText) {
                        html += '<div class="video-duration">' + escapeHtml(durationText) + '</div>';
                    }

                    html += '</div>'
                        + '<div class="file-name" title="' + name + '">' + name + '</div>'
                        + '<div class="file-info">' + count + '</div>'
                        + '</a>';
                } else {
                    html += '<a href="' + link + '" class="file-item" data-item-type="' + escapeHtml(type) + '">';

                    if (telegramLink) {
                        html += '<span class="btn-open-telegram" data-telegram-link="' + escapeHtml(telegramLink) + '" title="Abrir en Telegram">'
                            + '<i class="fa-brands fa-telegram"></i>'
                            + '</span>';
                    }

                    html += '<div class="icon-box folder-box">'
                        + '<i class="fas fa-folder folder-chat folder-icon"></i>';
                    if (photoId) {
                        html += '<img src="/api/photo/' + encodeURIComponent(photoId)
                            + '?tipo=grupo" class="profile-img folder-overlay" loading="lazy">';
                    }
                    html += '</div>'
                        + '<div class="file-name" title="' + name + '">' + name + '</div>'
                        + '<div class="file-info">' + count + '</div>'
                        + '</a>';
                }
            });

            grid.innerHTML = html;
            applyHiddenStateToAll();
            applyDuplicateFilter();
            setupHoverPreviews(); // Re-aplicar listeners
        }

        async function fetchAndRender() {
            try {
                var res = await fetch('/api/folder/' + encodeURIComponent(folderId));
                if (!res.ok) {
                    console.error('Error recargando carpeta', res.status);
                    return;
                }
                var data = await res.json();
                renderItems(data);
            } catch (e) {
                console.error('Error fetch /api/folder', e);
            }
        }

        var loc = window.location;
        var proto = (loc.protocol === 'https:') ? 'wss:' : 'ws:';
        var wsUrl = proto + '//' + loc.host + '/ws/folder/' + encodeURIComponent(folderId);

        var ws;
        try {
            ws = new WebSocket(wsUrl);
        } catch (e) {
            console.error('No se pudo abrir WebSocket de carpeta', e);
            return;
        }

        ws.onmessage = function (event) {
            try {
                var payload = JSON.parse(event.data);
                if (payload && payload.type === 'refresh') {
                    fetchAndRender();
                }
            } catch (e) {
                console.error('Mensaje WS inválido', e);
            }
        };

        window.addEventListener('beforeunload', function () {
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
            } catch (e) {}
        });
    }

    // --- Inicialización ---
    setupHoverPreviews();
    setupLiveFolderUpdates();
    applyHiddenStateToAll();
    applyDuplicateFilter();

    // Btn Sync Diario
    var btnSync = document.getElementById("btn-sync-diario");
    if (btnSync) {
        btnSync.addEventListener("click", async () => {
            btnSync.disabled = true;
            btnSync.textContent = "Sincronizando...";
            try {
                await fetch("/sync/diario", { method: "POST" });
                alert("Sincronización completada");
            } catch (e) {
                console.error("Error sync diario", e);
                alert("Error al sincronizar");
            } finally {
                btnSync.disabled = false;
                btnSync.textContent = "Sincronizar diario";
            }
        });
    }

})();
</script>
