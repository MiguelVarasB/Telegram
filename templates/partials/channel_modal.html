<div id="channel-modal-overlay" class="channel-modal-overlay" style="display:none;">
    <div class="channel-modal">
        <button type="button" class="modal-close" id="channel-modal-close" aria-label="Cerrar">&times;</button>
        <h3 id="channel-modal-title">Canal</h3>
        <div class="meta" id="channel-modal-meta">
            <div>Type: -</div>
            <div>Usuario: -</div>
            <div>Indexados / Totales: -</div>
            <div>Último escaneo: -</div>
            <div>Último mensaje: -</div>
        </div>
        <div class="meta" id="data-pura" style="display: none;">
            
        </div>
        <div class="actions">
            <button type="button" class="btn-sync" id="channel-modal-scan">Indexar faltantes</button>
            <button type="button" class="channel-modal-open btn-light" id="channel-modal-open">Abrir canal</button>
        </div>
        <div class="meta" id="channel-modal-status" style="margin-top:10px;"></div>
    </div>
</div>

<script>
// Fallback ligero por si el listener global no se monta (versión jQuery)
(function () {
    function bootChannelModal() {
        if (window.__channelModalInitialized) return true;
        if (!window.jQuery) return false; // esperamos a que cargue jQuery
        window.__channelModalInitialized = true;
        const $ = window.jQuery;
        const $overlay = $('#channel-modal-overlay');
        const $closeBtn = $('#channel-modal-close');
        const $openBtn = $('#channel-modal-open');
        const $statusEl = $('#channel-modal-status');
        const $titleEl = $('#channel-modal-title');
        const $metaEl = $('#channel-modal-meta');
        const $scanBtn = $('#channel-modal-scan');
        let chatId = null;
        let chatHref = null;

        function fillMeta(data) {
            if (!$metaEl.length) return;
            if (window.App?.behaviors?.fillChannelMeta) {
                try { window.App.behaviors.fillChannelMeta(data); } catch (e) {}
                return;
            }
            const parts = [];
            if (data.type) parts.push(`Tipo: ${data.type}`);
            if (data.username) parts.push(`Usuario: @${data.username}`);
            parts.push(`Indexados / Totales: ${(data.indexed_videos||0)} / ${(data.total_videos||0)}`);
            if (data.scanned_at) parts.push(`Último escaneo: ${data.scanned_at}`);
            if (data.last_message_date) parts.push(`Último mensaje: ${data.last_message_date}`);
            $metaEl.html(parts.map(t => `<div>${t}</div>`).join(''));
        }

        async function fetchInfo(id) {
            if (!id) return;
            try {
                const res = await fetch(`/api/channel/${encodeURIComponent(id)}/info`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                fillMeta(data);
                // Mostrar JSON completo en data-pura
                $('#data-pura').text(JSON.stringify(data, null, 2)).show();
                $statusEl.text('');
            } catch (e) {
                $statusEl.text('Error al cargar info del canal');
                $('#data-pura').hide();
            }
        }

        function openModal(btn) {
            const $btn = $(btn);
            chatId = $btn.data('chatId') || null;
            chatHref = $btn.closest('.file-item').attr('href') || null;
            if ($titleEl.length) $titleEl.text($btn.data('chatName') || 'Canal');
            fillMeta({
                type: $btn.data('chatType'),
                username: $btn.data('username'),
                indexed_videos: $btn.data('indexed'),
                total_videos: $btn.data('total'),
                scanned_at: $btn.data('scannedAt'),
                last_message_date: $btn.data('lastMessage'),
            });
            $statusEl.text('Cargando info...');
            $('#data-pura').hide().text(''); // Ocultar y limpiar JSON
            $overlay.stop(true, true).css('display', 'flex').hide().fadeIn(150);
            fetchInfo(chatId);
        }

        function closeModal() {
            $overlay.stop(true, true).fadeOut(150, function() {
                $overlay.css('display', 'none');
                $statusEl.text('');
                $('#data-pura').hide().text(''); // Limpiar JSON al cerrar
            });
        }

        $(document).on('click', '.open-channel-modal', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            openModal(this);
        });

        $closeBtn.on('click', closeModal);

        $overlay.on('click', function(ev) {
            if (ev.target === this) closeModal();
        });

        $openBtn.on('click', function() {
            if (chatHref) window.location.href = chatHref;
            else if (chatId) window.location.href = `/channel/${encodeURIComponent(chatId)}`;
        });

        // Compatibilidad con onclick inline en cards
        window.openChannelModalFromButton = function(btn) {
            openModal(btn);
            return false;
        };

        return true;
    }

    // Intentar iniciar; si no hay jQuery aún, reintentar al cargar DOM/load
    if (!bootChannelModal()) {
        document.addEventListener('DOMContentLoaded', bootChannelModal);
        window.addEventListener('load', bootChannelModal);
        // pequeño retardo por si jQuery llega justo después
        setTimeout(bootChannelModal, 200);
    }
})();
</script>
