<div id="channel-modal-overlay" class="channel-modal-overlay">
    <div class="channel-modal">
        <button type="button" class="modal-close" id="channel-modal-close" aria-label="Cerrar">&times;</button>
        <h3 id="channel-modal-title">Canal</h3>
        <div class="meta" id="channel-modal-meta">
            <div>Type: -</div>
            <div>Usuario: -</div>
            <div>Indexados / Totales: -</div>
            <div>Último escaneo: -</div>
            <div>Último mensaje: -</div>
        </div>
        <div class="actions">
            <button type="button" class="btn-sync" id="channel-modal-scan">Indexar faltantes</button>
            <button type="button" class="channel-modal-open btn-light" id="channel-modal-open">Abrir canal</button>
        </div>
        <div class="meta" id="channel-modal-status" style="margin-top:10px;"></div>
    </div>
</div>

<script>
// Fallback ligero por si el listener global no se monta
(function () {
    if (window.__channelModalInitialized) return;
    window.__channelModalInitialized = true;
    const overlay = document.getElementById('channel-modal-overlay');
    const closeBtn = document.getElementById('channel-modal-close');
    const titleEl = document.getElementById('channel-modal-title');
    const metaEl = document.getElementById('channel-modal-meta');
    const statusEl = document.getElementById('channel-modal-status');
    const scanBtn = document.getElementById('channel-modal-scan');
    const openBtn = document.getElementById('channel-modal-open');
    let chatId = null;
    let chatHref = null;
    function fillMeta(data) {
        if (!metaEl) return;
        const parts = [];
        if (data.type) parts.push(`Tipo: ${data.type}`);
        if (data.username) parts.push(`Usuario: @${data.username}`);
        parts.push(`Indexados / Totales: ${(data.indexed_videos||0)} / ${(data.total_videos||0)}`);
        if (data.scanned_at) parts.push(`Último escaneo: ${data.scanned_at}`);
        if (data.last_message_date) parts.push(`Último mensaje: ${data.last_message_date}`);
        metaEl.innerHTML = parts.map(t => `<div>${t}</div>`).join('');
    }
    async function fetchInfo(id) {
        if (!id) return;
        try {
            const res = await fetch(`/api/channel/${encodeURIComponent(id)}/info`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            fillMeta(data);
            if (statusEl) statusEl.textContent = '';
        } catch (e) {
            if (statusEl) statusEl.textContent = 'Error al cargar info del canal';
        }
    }
    function openModal(btn) {
        chatId = btn.dataset.chatId || null;
        chatHref = btn.closest('.file-item')?.getAttribute('href') || null;
        if (titleEl) titleEl.textContent = btn.dataset.chatName || 'Canal';
        fillMeta({
            type: btn.dataset.chatType,
            indexed_videos: btn.dataset.indexed,
            total_videos: btn.dataset.total,
            scanned_at: btn.dataset.scannedAt,
            last_message_date: btn.dataset.lastMessage,
        });
        if (statusEl) statusEl.textContent = 'Cargando info...';
        overlay?.classList.add('is-open');
        fetchInfo(chatId);
    }
    document.addEventListener('click', function(ev) {
        const btn = ev.target.closest('.open-channel-modal');
        if (!btn) return;
        ev.preventDefault();
        ev.stopPropagation();
        openModal(btn);
    });
    closeBtn?.addEventListener('click', function() {
        overlay?.classList.remove('is-open');
    });
    overlay?.addEventListener('click', function(ev) {
        if (ev.target === overlay) overlay.classList.remove('is-open');
    });
    scanBtn?.addEventListener('click', async function() {
        if (!chatId) return;
        scanBtn.disabled = true;
        if (statusEl) statusEl.textContent = 'Lanzando escaneo...';
        try {
            const res = await fetch(`/api/channel/${encodeURIComponent(chatId)}/scan`, { method: 'POST' });
            if (!res.ok) throw new Error();
            if (statusEl) statusEl.textContent = 'Escaneo iniciado en segundo plano';
        } catch (e) {
            if (statusEl) statusEl.textContent = 'Error al iniciar escaneo';
        } finally {
            scanBtn.disabled = false;
        }
    });
    openBtn?.addEventListener('click', function() {
        if (chatHref) window.location.href = chatHref;
        else if (chatId) window.location.href = `/channel/${encodeURIComponent(chatId)}`;
    });
})();
</script>
